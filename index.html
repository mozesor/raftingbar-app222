<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>רפטינג בר – שעון נוכחות</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="styles.css?v=1">
</head>
<body class="dark">
  <header class="app-header">
    <h1>רפטינג בר 🎉</h1>
    <div class="clock" id="clock"></div>
  </header>

  <main class="container card">
    <h2 class="section-title">רישום נוכחות</h2>
    <div class="grid">
      <div class="form-group">
        <label>בחר עובד:</label>
        <select id="employeeSelect">
          <option value="">בחר עובד...</option>
        </select>
      </div>
      <div class="form-group actions">
        <button id="btnIn" class="btn ok">כניסה</button>
        <button id="btnOut" class="btn danger">יציאה</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="todayHours">0</div>
        <div class="stat-label">שעות היום</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-label">עובדים פעילים</div>
      </div>
    </div>

    <div id="status" class="status muted"></div>
  </main>

  <footer class="footer muted">גרסה: PWA-AppsScript</footer>

  <script>
    // === Embedded settings ===
    const sheetId = "1BxSOIHpJSY3UrO-x_PL2amHivd4K_UBhK8EbQsSHVGI";
    const webAppUrl = "YOUR_WEB_APP_DEPLOYMENT_URL_HERE"; // תעדכן אחרי שתפרוס את Apps Script
    const adminToken = "1986";

    // Namespaced storage to avoid collisions
    const LOCAL_NS = 'clockapp_' + sheetId;
    const store = {
      get: (k) => localStorage.getItem(LOCAL_NS + '_' + k),
      set: (k,v) => localStorage.setItem(LOCAL_NS + '_' + k, v),
      del: (k) => localStorage.removeItem(LOCAL_NS + '_' + k),
    };

    function setStatus(msg, ok=true) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status ' + (ok ? 'ok' : 'danger');
    }

    function tickClock(){
      const el = document.getElementById('clock');
      const now = new Date();
      el.textContent = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(tickClock, 1000); tickClock();

    async function apiGetEmployees() {
      const url = webAppUrl + "?fn=employees&token=" + encodeURIComponent(adminToken);
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('שגיאת חיבור (employees)');
      return r.json();
    }
    async function apiLog(action, employee) {
      const r = await fetch(webAppUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fn: 'log', token: adminToken, employee, action, ts: new Date().toISOString() })
      });
      if (!r.ok) throw new Error('שגיאת חיבור (log)');
      return r.json();
    }
    async function apiStats() {
      const url = webAppUrl + "?fn=stats&token=" + encodeURIComponent(adminToken);
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('שגיאת חיבור (stats)');
      return r.json();
    }

    async function refreshEmployees() {
      try {
        const data = await apiGetEmployees();
        const sel = document.getElementById('employeeSelect');
        sel.innerHTML = '<option value="">בחר עובד...</option>';
        (data.employees || []).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        setStatus('רשימת עובדים נטענה', true);
      } catch(e) {
        setStatus('לא הצלחתי לטעון עובדים – בדוק את קישור ה-Web App והרשאות', false);
      }
    }

    async function refreshStats() {
      try {
        const s = await apiStats();
        document.getElementById('todayHours').textContent = s.todayHours ?? '0';
        document.getElementById('activeCount').textContent = s.activeCount ?? '0';
      } catch(e) {
        // מצב לא מקוון או בעיה — לא להפחיד את המשתמש
      }
    }

    document.getElementById('btnIn').addEventListener('click', async () => {
      const sel = document.getElementById('employeeSelect');
      if (!sel.value) return setStatus('בחר עובד קודם', false);
      try {
        await apiLog('in', sel.value);
        setStatus('נרשם: כניסה', true);
        refreshStats();
      } catch(e) {
        setStatus('כשל ברישום כניסה', false);
      }
    });
    document.getElementById('btnOut').addEventListener('click', async () => {
      const sel = document.getElementById('employeeSelect');
      if (!sel.value) return setStatus('בחר עובד קודם', false);
      try {
        await apiLog('out', sel.value);
        setStatus('נרשם: יציאה', true);
        refreshStats();
      } catch(e) {
        setStatus('כשל ברישום יציאה', false);
      }
    });

    // boot
    refreshEmployees();
    refreshStats();

    // Service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?v=2').catch(console.error);
      });
    }
  </script>
</body>
</html>
